/**
 * A JavaScript implementation of an OIDC Public Client 
 *
 * Copyright (c) AVOCO SECURE LTD. All rights reserved.
 * Licensed under the MIT License, you may not use this file except in compliance with
 * the License.
 * See https://github.com/avoco-identity/OIDC-RP-PKCE for more information
 *
 *
 * THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED,
 * INCLUDING WITHOUT LIMITATION ANY IMPLIED WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
 * MERCHANTABLITY OR NON-INFRINGEMENT.
 *
 */
var App={gCookieName:"oidcrpsettings",getParams:function(e){for(var t,o={},i=/\+/g,n=/([^&;=]+)=?([^&;]*)/g,s=function(e){return decodeURIComponent(e.replace(i," "))};t=n.exec(e);)o[s(t[1])]=s(t[2]);this.urlParams=o},getParam:function(e){return this.urlParams&&this.urlParams[e]?this.urlParams[e]:""},displayNotification:function(e,t,o,i){UIkit.notification('<span class="uk-text-bold">'+e+"</span><br>"+t,{status:o,timeout:!0===i?0:6e3})},displayError:function(e,t){var o="Error: "+e+"<br>Description: "+t;this.displayNotification("Information",o,"danger")},setCookie:function(e,t,o){var i="";if(o){var n=new Date;n.setDate(n.getDate()+o),i="; expires="+n.toGMTString()}document.cookie=`${e}=${t}${i};secure;path=${window.location.pathname}`},getCookie:function(e){var t,o,i,n,s=document.cookie.split(";");for(t=0;t<s.length;t++)if((n=s[t].indexOf("="))>-1&&(o=s[t].substr(0,n),i=s[t].substr(n+1),(o=o.replace(/^\s+|\s+$/g,""))==e))return unescape(i);return""},getRandomString:function(e){var t,o,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="";for(o=new Uint32Array(e),window.crypto.getRandomValues(o),t=0;t<e;t++)n+=i[o[t]%i.length];return n},base64URLEncode:function(e){return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")},displayLocalTime:function(e){return new Date(1e3*e).toLocaleString()},getCallback:function(){return window.location.href.split("?")[0].split("#")[0]},displayTokenData:function(e){if(e.id_token){var t=this.parseJwt(e.id_token);$("#dividtoken").html("<p>ID Token</p>"+this.formatJSON(this.syntaxHighlight(JSON.stringify(t,void 0,2))))}else $("#dividtoken").html("");e.access_token&&$.ajax({type:"GET",url:Settings.options.profileurl,headers:{Authorization:"Bearer "+e.access_token},dataType:"json",contentType:"application/json",success:function(e){if(e.picture&&(e.picture=""),$("#divattr").html(App.formatJSON(App.syntaxHighlight(JSON.stringify(e)))),e.id&&$("#userid").val(e.id),e.name&&$("#username").val(e.name),e.email&&$("#useremail").val(e.email),e.mobile&&$("#usermobile").val(e.mobile),e.dateofbirth&&$("#userdob").val(e.dateofbirth),e.address){var t=e.address.formatted.replace(/(\n)+/g," ");$("#useraddress").val(t)}App.showClaimsFields(),$("#divres").show()},error:function(e,t,o){App.displayError(e.responseJSON.error,e.responseJSON.error_description)}})},showClaimsFields:function(){Settings.options.fields&&$.each(Settings.options.fields,function(e,t){!0===t?$("#field_"+e).show():$("#field_"+e).hide()})},parseJwt:function(e){var t=e.split(".")[1].replace("-","+").replace("_","/");return JSON.parse(window.atob(t))},formatJSON:function(e){return e.replace(/,/g,",<br>")},syntaxHighlight:function(e){return(e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")).replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(e){var t="number";return/^"/.test(e)?t=/:$/.test(e)?"key":"string":/true|false/.test(e)?t="boolean":/null/.test(e)&&(t="null"),'<span class="'+t+'">'+e+"</span>"})},extractHostname:function(e,t){let o;if(o=(o=(o=e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0]).split(":")[0]).split("?")[0],t){let e=o.split(".");o=e[e.length-2]+"."+e[e.length-1]}return o},clearTokenDisplay:function(){$("#dividtoken").html(""),$("#divattr").html("")}},Settings={options:{},update:function(){var e={};return $("#form-config")[0].checkValidity()?(e.authnurl=$("#authnurl").val(),e.tokenurl=$("#tokenurl").val(),e.profileurl=$("#profileurl").val(),e.jwksurl=$("#jwksurl").val(),e.provissuer=$("#provissuer").val(),e.oauth_server=$("#oauth_server").val(),e.ciba_url=$("#ciba_url").val(),e.oauth_clientid=$("#oauth_clientid").val(),e.idp_hint=$("#idp_hint").val(),e.request_mode=$("#request_mode").val(),e.response_mode=$("#response_mode").val(),e.window_type=$("#window_type").val(),e.oauth_scope=$("#oauth_scope").val(),e.oauth=!!$("#useoauth2").is(":checked"),e.acr_values=$("#acr_values").val(),e.fields={},e.fields.name=!!$("#form_name").is(":checked"),e.fields.email=!!$("#form_email").is(":checked"),e.fields.mobile=!!$("#form_mobile").is(":checked"),e.fields.dob=!!$("#form_dob").is(":checked"),e.fields.address=!!$("#form_address").is(":checked"),this.options=e,!0):($('<input type="submit">').hide().appendTo($("#form-config")).click().remove(),!1)},import:function(e){this.options=e,$("#authnurl").val(this.options.authnurl),$("#tokenurl").val(this.options.tokenurl),$("#profileurl").val(this.options.profileurl),$("#jwksurl").val(this.options.jwksurl),$("#provissuer").val(this.options.provissuer),$("#oauth_server").val(this.options.oauth_server),$("#ciba_url").val(this.options.ciba_url),$("#oauth_clientid").val(this.options.oauth_clientid),$("#useoauth2").prop("checked",this.options.oauth),$("#idp_hint").val(this.options.idp_hint),$("#request_mode").val(this.options.request_mode),$("#response_mode").val(this.options.response_mode),$("#window_type").val(this.options.window_type),$("#oauth_scope").val(this.options.oauth_scope),$("#acr_values").val(this.options.acr_values),this.options.fields&&($("#form_name").prop("checked",this.options.fields.name),$("#form_email").prop("checked",this.options.fields.email),$("#form_mobile").prop("checked",this.options.fields.mobile),$("#form_dob").prop("checked",this.options.fields.dob),$("#form_address").prop("checked",this.options.fields.address))},load:function(){var e=App.getCookie(App.gCookieName);if(e.length>0)try{var t=JSON.parse(e);return void this.import(t)}catch(e){}else if("undefined"!=typeof config)return void this.import(config);this.edit()},edit:function(){null!=this.options.provissuer&&this.options.provissuer.length>0?($("#discep").attr("href",this.options.provissuer+"/.well-known/openid-configuration"),$("#discep").show()):$("#discep").hide(),App.dlgConfig.show()}},OAuth={exchangeCode:function(e,t,o){var i=Settings.options,n={code:e,grant_type:"authorization_code",client_id:i.oauth_clientid,redirect_uri:App.getCallback()};null!=o&&!1!==o||(n.client_secret=i.oauth_clientsecret),sessionStorage.codeVerifier&&sessionStorage.codeVerifier.length>0&&(n.code_verifier=sessionStorage.codeVerifier),$.ajax({type:"POST",url:i.tokenurl,data:JSON.stringify(n),contentType:"application/json",dataType:"json",success:function(e){App.displayTokenData(e),sessionStorage.codeVerifier=""},error:function(e,t,o){App.displayError(e.responseJSON.error,e.responseJSON.error_description)}})},startAuth:function(e){void 0===e&&(e=""),sessionStorage.state=App.getRandomString(32);var t=Settings.options,o="client_id="+t.oauth_clientid,i=t.oauth_scope;o+="&state="+sessionStorage.state,t.response_mode.length>0&&(o+="&response_mode="+t.response_mode),o+="&redirect_uri="+encodeURIComponent(App.getCallback()),!0!==Settings.options.oauth&&(sessionStorage.nonce=App.getRandomString(32),o+="&nonce="+sessionStorage.nonce,-1==i.indexOf("openid")&&(i+=" openid")),o+="&scope="+i,sessionStorage.codeVerifier=App.base64URLEncode(App.getRandomString(32));var n=new jsSHA("SHA-256","TEXT",1);n.update(sessionStorage.codeVerifier),o+="&response_type=code",o+="&code_challenge="+App.base64URLEncode(n.getHash("BYTES"))+"&code_challenge_method=S256",""!==e&&void 0!==e?o+="&idp_hint="+e:t.idp_hint.length&&(o+="&idp_hint="+t.idp_hint);var s=t.authnurl+"?"+o;if(null!=t.window_type){var r=600,a=600,p=screen.width/2-a/2,l=screen.height/2-r/2;e:if("_default"!=t.window_type)if("_tab"!=t.window_type){if("_blank"==t.window_type)r=600,a=600;else if("_blank_m"==t.window_type)r=800,a=800;else{if("_blank_l"!=t.window_type){window.location.href=s;break e}r=1e3,a=800}window.open(s,"authn","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+a+", height="+r+", top="+l+", left="+p)}else window.open(s,"authn");else window.open(s,"authn")}else if("web_message"==t.response_mode){r=600,a=600,p=screen.width/2-a/2,l=screen.height/2-r/2;window.open(s,"authn","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+a+", height="+r+", top="+l+", left="+p)}else window.location.href=s}};$(function(){if(App.dlgConfig=new UIkit.modal("#dlg_config"),Settings.load(),window.location.hash)App.getParams(window.location.hash.substring(1)),window.location.hash="",history.replaceState("",document.title,window.location.pathname);else{var e=window.location.href,t=e.indexOf("?")+1;App.getParams(e.substring(t))}App.clearTokenDisplay();var o=App.getParam("error");if(o.length>0)App.displayError(o,App.getParam("error_description"));else{var i=App.getParam("code");if(i.length>20)OAuth.exchangeCode(i,!1,!0);else if(App.getParam("access_token").length>0||App.getParam("id_token").length>0){var n={access_token:App.getParam("access_token"),expires_in:App.getParam("expires_in"),id_token:App.getParam("id_token"),refresh_token:App.getParam("refresh_token")};App.displayTokenData(n)}}var s=$("input[name=new_email],input[name=new_mobile]");s.on("input",function(){s.not(this).prop("required",!$(this).val().length)}),window.addEventListener("message",function(e){if(App.extractHostname(e.origin,!1)===App.extractHostname(Settings.options.provissuer,!1)){if(e.data&&e.data.response)if(void 0!==(t=e.data.response).code&&t.code.length>20)OAuth.exchangeCode(t.code,!0,!0);else if(void 0!==t.access_token&&t.access_token.length>0||void 0!==t.id_token&&t.length.length>0){var t={access_token:void 0!==t.access_token?t.access_token:"",expires_in:t.expires_in,id_token:void 0!==t.id_token?t.id_token:"",refresh_token:void 0!==t.refresh_token?t.refresh_token:""};console.log("here!"),App.displayTokenData(t)}}else App.displayError(o,"Event origin mismatch")},!1),$("#btn_persistcookie").click(function(e){e.preventDefault(),Settings.update()&&(App.setCookie(App.gCookieName,JSON.stringify(Settings.options),365),App.displayNotification("Result","Saved for 1 year","success"))}),$("#btn_persistjson").click(function(e){if(e.preventDefault(),Settings.update()){var t="var config="+JSON.stringify(Settings.options),o=window.URL||window.webkitURL,i=new Blob([t],{type:"text/plain"}),n=o.createObjectURL(i),s=document.createElement("a");s.href=n,s.download="config.js",document.body.appendChild(s),s.click(),s.remove()}}),$("#btn_startauth").click(function(e){e.preventDefault(),$("#divres").hide(),$("#formres")[0].reset(),OAuth.startAuth()}),$(".idp-btn-startauth").click(function(e){if(e.preventDefault(),$("#divres").hide(),$("#formres")[0].reset(),-1!=$(this).attr("class").indexOf("idp-name-")){var t=(this.className.match(/(^|\s)(idp\-name\-[^\s]*)/)||[,,""])[2];t=t.substring(9),OAuth.startAuth(t)}else OAuth.startAuth()});var r={67:!1,70:!1,71:!1};$(document).keydown(function(e){e.keyCode in r&&(r[e.keyCode]=!0,r[67]&&r[70]&&r[71]&&Settings.edit())}).keyup(function(e){e.keyCode in r&&(r[e.keyCode]=!1)})});