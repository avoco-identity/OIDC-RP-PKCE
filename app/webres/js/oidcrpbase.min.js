/**
 * A JavaScript implementation of an OIDC Public Client 
 *
 * Copyright (c) AVOCO SECURE LTD. All rights reserved.
 * Licensed under the MIT License, you may not use this file except in compliance with
 * the License.
 * See https://github.com/avoco-identity/OIDC-RP-PKCE for more information
 *
 *
 * THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED,
 * INCLUDING WITHOUT LIMITATION ANY IMPLIED WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
 * MERCHANTABLITY OR NON-INFRINGEMENT.
 *
 */
 var App={gCookieName:"oidcrpsettings",getParams:function(q){for(var hashParams={},e,a=/\+/g,r=/([^&;=]+)=?([^&;]*)/g,d=function(s){return decodeURIComponent(s.replace(a," "))};e=r.exec(q);)hashParams[d(e[1])]=d(e[2]);this.urlParams=hashParams},getParam:function(name){return this.urlParams&&this.urlParams[name]?this.urlParams[name]:""},displayNotification:function(title,msg,stat,sticky){UIkit.notification('<span class="uk-text-bold">'+title+"</span><br>"+msg,{status:stat,timeout:!0===sticky?0:6e3})},displayError:function(error,error_description){var msg="Error: "+error+"<br>Description: "+error_description;this.displayNotification("Information",msg,"danger")},setCookie:function(c_name,c_value,c_exp_days){var expires="";if(c_exp_days){var date=new Date;date.setDate(date.getDate()+c_exp_days),expires="; expires="+date.toGMTString()}document.cookie=`${c_name}=${c_value}${expires};secure;path=${window.location.pathname}`},getCookie:function(c_name){var i,x,y,p,ARRcookies=document.cookie.split(";");for(i=0;i<ARRcookies.length;i++)if((p=ARRcookies[i].indexOf("="))>-1&&(x=ARRcookies[i].substr(0,p),y=ARRcookies[i].substr(p+1),(x=x.replace(/^\s+|\s+$/g,""))==c_name))return unescape(y);return""},getRandomString:function(length){var charset="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i,values,result="";for(values=new Uint32Array(length),window.crypto.getRandomValues(values),i=0;i<length;i++)result+=charset[values[i]%charset.length];return result},base64URLEncode:function(data){return btoa(data).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")},displayLocalTime:function(epochTime){var dt;return new Date(1e3*epochTime).toLocaleString()},getCallback:function(){return window.location.href.split("?")[0].split("#")[0]},displayTokenData:function(tokenData){if(tokenData.id_token){var json=this.parseJwt(tokenData.id_token);$("#dividtoken").html("<p>ID Token</p>"+this.formatJSON(this.syntaxHighlight(JSON.stringify(json,void 0,2))))}else $("#dividtoken").html("");tokenData.access_token&&$.ajax({type:"GET",url:Settings.options.profileurl,headers:{Authorization:"Bearer "+tokenData.access_token},dataType:"json",contentType:"application/json",success:function(data){if(data.picture&&(data.picture=""),$("#divattr").html(App.formatJSON(App.syntaxHighlight(JSON.stringify(data)))),data.id&&$("#userid").val(data.id),data.name&&$("#username").val(data.name),data.email&&$("#useremail").val(data.email),data.mobile&&$("#usermobile").val(data.mobile),data.dateofbirth&&$("#userdob").val(data.dateofbirth),data.address){var addr=data.address.formatted.replace(/(\n)+/g," ");$("#useraddress").val(addr)}App.showClaimsFields(),$("#divres").show()},error:function(jqXHR,textStatus,errorThrown){App.displayError(jqXHR.responseJSON.error,jqXHR.responseJSON.error_description)}})},showClaimsFields:function(){Settings.options.fields&&$.each(Settings.options.fields,(function(key,value){!0===value?$("#field_"+key).show():$("#field_"+key).hide()}))},parseJwt:function(token){var base64Url,base64=token.split(".")[1].replace("-","+").replace("_","/");return JSON.parse(window.atob(base64))},formatJSON:function(json){return json.replace(/,/g,",<br>")},syntaxHighlight:function(json){return(json=json.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")).replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,(function(match){var cls="number";return/^"/.test(match)?cls=/:$/.test(match)?"key":"string":/true|false/.test(match)?cls="boolean":/null/.test(match)&&(cls="null"),'<span class="'+cls+'">'+match+"</span>"}))},extractHostname:function(url,tld){let hostname;if(hostname=url.indexOf("://")>-1?url.split("/")[2]:url.split("/")[0],hostname=hostname.split(":")[0],hostname=hostname.split("?")[0],tld){let hostnames=hostname.split(".");hostname=hostnames[hostnames.length-2]+"."+hostnames[hostnames.length-1]}return hostname},clearTokenDisplay:function(){$("#dividtoken").html(""),$("#divattr").html("")}},Settings={options:{},update:function(){var settings={};return $("#form-config")[0].checkValidity()?(settings.authnurl=$("#authnurl").val(),settings.tokenurl=$("#tokenurl").val(),settings.profileurl=$("#profileurl").val(),settings.jwksurl=$("#jwksurl").val(),settings.provissuer=$("#provissuer").val(),settings.oauth_server=$("#oauth_server").val(),settings.ciba_url=$("#ciba_url").val(),settings.oauth_clientid=$("#oauth_clientid").val(),settings.idp_hint=$("#idp_hint").val(),settings.request_mode=$("#request_mode").val(),settings.response_mode=$("#response_mode").val(),settings.window_type=$("#window_type").val(),settings.oauth_scope=$("#oauth_scope").val(),settings.oauth=!!$("#useoauth2").is(":checked"),settings.usepost=!!$("#usepost").is(":checked"),settings.usejwt=!!$("#usejwt").is(":checked"),settings.acr_values=$("#acr_values").val(),settings.fields={},settings.fields.name=!!$("#form_name").is(":checked"),settings.fields.email=!!$("#form_email").is(":checked"),settings.fields.mobile=!!$("#form_mobile").is(":checked"),settings.fields.dob=!!$("#form_dob").is(":checked"),settings.fields.address=!!$("#form_address").is(":checked"),this.options=settings,!0):($('<input type="submit">').hide().appendTo($("#form-config")).click().remove(),!1)},import:function(settings){this.options=settings,$("#authnurl").val(this.options.authnurl),$("#tokenurl").val(this.options.tokenurl),$("#profileurl").val(this.options.profileurl),$("#jwksurl").val(this.options.jwksurl),$("#provissuer").val(this.options.provissuer),$("#oauth_server").val(this.options.oauth_server),$("#ciba_url").val(this.options.ciba_url),$("#oauth_clientid").val(this.options.oauth_clientid),$("#useoauth2").prop("checked",this.options.oauth),$("#idp_hint").val(this.options.idp_hint),$("#request_mode").val(this.options.request_mode),$("#response_mode").val(this.options.response_mode),$("#window_type").val(this.options.window_type),$("#oauth_scope").val(this.options.oauth_scope),$("#usepost").prop("checked",this.options.usepost),$("#usejwt").prop("checked",this.options.usejwt),$("#acr_values").val(this.options.acr_values),this.options.fields&&($("#form_name").prop("checked",this.options.fields.name),$("#form_email").prop("checked",this.options.fields.email),$("#form_mobile").prop("checked",this.options.fields.mobile),$("#form_dob").prop("checked",this.options.fields.dob),$("#form_address").prop("checked",this.options.fields.address))},load:function(){var cookieData=App.getCookie(App.gCookieName);if(cookieData.length>0)try{var jsonData=JSON.parse(cookieData);return void this.import(jsonData)}catch(objError){}else if("undefined"!=typeof config)return void this.import(config);this.edit()},edit:function(){null!=this.options.provissuer&&this.options.provissuer.length>0?($("#discep").attr("href",this.options.provissuer+"/.well-known/openid-configuration"),$("#discep").show()):$("#discep").hide(),App.dlgConfig.show()}},OAuth={exchangeCode:function(code,isWebMessage,nosecret){var settings=Settings.options,dt={code:code,grant_type:"authorization_code",client_id:settings.oauth_clientid,redirect_uri:App.getCallback()};null!=nosecret&&!1!==nosecret||(dt.client_secret=settings.oauth_clientsecret),sessionStorage.codeVerifier&&sessionStorage.codeVerifier.length>0&&(dt.code_verifier=sessionStorage.codeVerifier),$.ajax({type:"POST",url:settings.tokenurl,data:JSON.stringify(dt),contentType:"application/json",dataType:"json",success:function(data){App.displayTokenData(data),sessionStorage.codeVerifier=""},error:function(jqXHR,textStatus,errorThrown){App.displayError(jqXHR.responseJSON.error,jqXHR.responseJSON.error_description)}})},startAuth:function(){sessionStorage.state=App.getRandomString(32);var settings=Settings.options,qs="client_id="+settings.oauth_clientid,scope=settings.oauth_scope;qs+="&state="+sessionStorage.state,settings.response_mode.length>0&&(qs+="&response_mode="+settings.response_mode),qs+="&redirect_uri="+encodeURIComponent(App.getCallback()),!0!==Settings.options.oauth&&(sessionStorage.nonce=App.getRandomString(32),qs+="&nonce="+sessionStorage.nonce,-1==scope.indexOf("openid")&&(scope+=" openid")),qs+="&scope="+scope,sessionStorage.codeVerifier=App.base64URLEncode(App.getRandomString(32));var hashObj=new jsSHA("SHA-256","TEXT",1),b64_hash;hashObj.update(sessionStorage.codeVerifier),qs+="&response_type=code",qs+="&code_challenge="+App.base64URLEncode(hashObj.getHash("BYTES"))+"&code_challenge_method=S256",settings.idp_hint.length&&(qs+="&idp_hint="+settings.idp_hint);var url=settings.authnurl+"?"+qs;if(settings.usepost&&(qs+="&callback="+encodeURIComponent(App.getCallback()),qs+="&provurl="+encodeURIComponent(settings.authnurl),settings.usejwt&&(qs+="&jwt=1",qs+="&aud="+settings.provissuer),url=settings.oauth_server+"?"+qs),null!=settings.window_type){var h=600,w=600,left=screen.width/2-w/2,top=screen.height/2-h/2;windowopenlab:if("_default"!=settings.window_type)if("_tab"!=settings.window_type){if("_blank"==settings.window_type)var h=600,w=600;else if("_blank_m"==settings.window_type)var h=800,w=800;else{if("_blank_l"!=settings.window_type){window.location.href=url;break windowopenlab}var h=1e3,w=800}window.open(url,"authn","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+w+", height="+h+", top="+top+", left="+left)}else window.open(url,"authn");else window.open(url,"authn")}else if("web_message"==settings.response_mode){var h=600,w=600,left=screen.width/2-w/2,top=screen.height/2-h/2;window.open(url,"authn","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+w+", height="+h+", top="+top+", left="+left)}else window.location.href=url}};$((function(){if(App.dlgConfig=new UIkit.modal("#dlg_config"),Settings.load(),window.location.hash)App.getParams(window.location.hash.substring(1)),window.location.hash="",history.replaceState("",document.title,window.location.pathname);else{var queryString=window.location.href,pos=queryString.indexOf("?")+1;App.getParams(queryString.substring(pos))}App.clearTokenDisplay();var error=App.getParam("error");if(error.length>0)App.displayError(error,App.getParam("error_description"));else{var code=App.getParam("code");if(code.length>20)OAuth.exchangeCode(code,!1,!0);else if(App.getParam("access_token").length>0||App.getParam("id_token").length>0){var tokenData={access_token:App.getParam("access_token"),expires_in:App.getParam("expires_in"),id_token:App.getParam("id_token"),refresh_token:App.getParam("refresh_token")};App.displayTokenData(tokenData)}}var $inputs=$("input[name=new_email],input[name=new_mobile]");$inputs.on("input",(function(){$inputs.not(this).prop("required",!$(this).val().length)})),window.addEventListener("message",(function(event){var tokenData;if(App.extractHostname(event.origin,!1)===App.extractHostname(Settings.options.provissuer,!1)){if(event.data&&event.data.response)if(void 0!==(tokenData=event.data.response).code&&tokenData.code.length>20)OAuth.exchangeCode(tokenData.code,!0,!0);else if(void 0!==tokenData.access_token&&tokenData.access_token.length>0||void 0!==tokenData.id_token&&tokenData.length.length>0){var tokenData={access_token:void 0!==tokenData.access_token?tokenData.access_token:"",expires_in:tokenData.expires_in,id_token:void 0!==tokenData.id_token?tokenData.id_token:"",refresh_token:void 0!==tokenData.refresh_token?tokenData.refresh_token:""};console.log("here!"),App.displayTokenData(tokenData)}}else App.displayError(error,"Event origin mismatch")}),!1),$("#btn_persistcookie").click((function(e){e.preventDefault(),Settings.update()&&(App.setCookie(App.gCookieName,JSON.stringify(Settings.options),365),App.displayNotification("Result","Saved for 1 year","success"))})),$("#btn_persistjson").click((function(e){if(e.preventDefault(),Settings.update()){var filename="config.js",$jsonData="var config="+JSON.stringify(Settings.options),URL=window.URL||window.webkitURL,textFileAsBlob=new Blob([$jsonData],{type:"text/plain"}),downloadUrl=URL.createObjectURL(textFileAsBlob),a=document.createElement("a");a.href=downloadUrl,a.download=filename,document.body.appendChild(a),a.click(),a.remove()}})),$("#btn_startauth").click((function(e){e.preventDefault(),$("#divres").hide(),$("#formres")[0].reset(),OAuth.startAuth()}));var map={67:!1,70:!1,71:!1};$(document).keydown((function(e){e.keyCode in map&&(map[e.keyCode]=!0,map[67]&&map[70]&&map[71]&&Settings.edit())})).keyup((function(e){e.keyCode in map&&(map[e.keyCode]=!1)}))}));